name: install-astronvim-robust
type: shell
commands:
  # Update and install basic dependencies
  - apt-get update
  - apt-get install -y software-properties-common
  - add-apt-repository ppa:neovim-ppa/unstable -y
  - apt-get update
  - apt-get install -y neovim curl git unzip xclip ripgrep golang-go python3 python3-pip nodejs npm

  # Install lazygit
  - curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
  - tar xf lazygit.tar.gz lazygit
  - install lazygit /usr/local/bin
  - rm lazygit lazygit.tar.gz

  # Install bottom
  - curl -sL https://raw.githubusercontent.com/ClementTsang/bottom/master/assets/download.sh | sh
  - mv ./bottom /usr/local/bin/

  # Install tree-sitter CLI
  - npm install -g tree-sitter-cli

  # Install JetBrains Mono Nerd Font
  - mkdir -p /usr/local/share/fonts/
  - curl -fLo "/usr/local/share/fonts/JetBrains Mono Regular Nerd Font Complete.ttf" https://github.com/ryanoasis/nerd-fonts/raw/master/patched-fonts/JetBrainsMono/Ligatures/Regular/complete/JetBrains%20Mono%20Regular%20Nerd%20Font%20Complete.ttf
  - fc-cache -f -v

  # Backup existing Neovim config (if any)
  - mv ~/.config/nvim ~/.config/nvim.bak 2>/dev/null || true
  - mv ~/.local/share/nvim ~/.local/share/nvim.bak 2>/dev/null || true
  - mv ~/.local/state/nvim ~/.local/state/nvim.bak 2>/dev/null || true
  - mv ~/.cache/nvim ~/.cache/nvim.bak 2>/dev/null || true

  # Clone AstroNvim template
  - git clone --depth 1 https://github.com/AstroNvim/template ~/.config/nvim
  - rm -rf ~/.config/nvim/.git

  # Install AstroNvim plugins
  - nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'

  # Cleanup
  - apt-get clean
  - rm -rf /var/lib/apt/lists/*